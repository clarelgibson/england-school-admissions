Source data preparation for the England school admissions dashboard
================
Clare Gibson

-   [Introduction](#introduction)
    -   [Source data](#source-data)
    -   [Required packages](#required-packages)
    -   [Custom functions](#custom-functions)
-   [Read data](#read-data)
    -   [Offers](#offers)
    -   [Info](#info)
    -   [Performance](#performance)
-   [Clean data](#clean-data)
    -   [Offers](#offers-1)
    -   [Info](#info-1)
    -   [Performance](#performance-1)

# Introduction

This notebook serves as the documented code to read and prepare data for
the England School Admissions Dashboard project
([github](https://github.com/clarelgibson/england-school-admissions) \|
[tableau](https://public.tableau.com/views/Schools_16505251102060/Home?:language=en-GB&:display_count=n&:origin=viz_share_link)).

I will begin by reading in the source data required for the dashboards.
I will then explain my intended approach to convert the source data into
a “star-schema” [dimensional
model](https://en.wikipedia.org/wiki/Dimensional_modeling), using
conformed dimensions to serve multiple fact tables. Finally I will work
through the data wrangling steps necessary to prepare the dimensional
model.

## Source data

The full list of data sources, download links and retrieval steps can be
found in the [project
wiki](https://github.com/clarelgibson/england-school-admissions/wiki/Source-data).

## Required packages

``` r
# Packages
library(tidyverse)      # for general wrangling
library(data.table)     # for transposing data frames
library(janitor)        # for cleaning column headers
library(lubridate)      # for working with dates
```

## Custom functions

I have created several custom functions to assist with data prep. Load
these functions by sourcing the `utils.R` script in the working
directory.

``` r
# Custom functions
source("utils.R")
```

# Read data

## Offers

This file contains data relating to the number of offers made to
applicants for secondary and primary school places since 2014, and the
proportion which received preferred offers. Data is aggregated at the
school level. Further details including an explanation of the
terminology used in this dataset can be found
[here](https://drive.google.com/drive/u/1/folders/1bbnbd9d4HDn3yXIIhaRSigZV46KpCyKy).

The source data is stored in a CSV file on [Google
Drive](https://drive.google.com/drive/u/1/folders/1lFZhobbGoCKKEtaZ5CDiphTbOxcbvJzW).
We can read the CSV file directly from the source location using the
custom function `read_csv_gdrive()`. When reading in source data, I
usually assign it to a variable with the prefix `src_` to indicate that
this is source data. Once I start to modify the data, I remove the
prefix. That way, I always have a copy of the original source data in
its unaltered form to refer back to.

``` r
# Read in the source data for offers
src_offers_path <- "https://drive.google.com/file/d/1bG0a0WRg-LEnASl6M3J0qyHJA_cMY1CQ/view?usp=sharing"
src_offers <- read_csv_gdrive(src_offers_path)
```

``` r
# List the columns and data types in the data frame
glimpse(src_offers)
```

    ## Rows: 171,385
    ## Columns: 35
    ## $ time_period                          <dbl> 202223, 202223, 202223, 202223, 2…
    ## $ time_identifier                      <chr> "Academic year", "Academic year",…
    ## $ geographic_level                     <chr> "School", "School", "School", "Sc…
    ## $ country_code                         <chr> "E92000001", "E92000001", "E92000…
    ## $ country_name                         <chr> "England", "England", "England", …
    ## $ region_code                          <chr> "E13000001", "E13000001", "E13000…
    ## $ region_name                          <chr> "Inner London", "Inner London", "…
    ## $ old_la_code                          <dbl> 201, 202, 202, 202, 202, 202, 202…
    ## $ new_la_code                          <chr> "E09000001", "E09000007", "E09000…
    ## $ la_name                              <chr> "City of London", "Camden", "Camd…
    ## $ school_phase                         <chr> "Primary", "Primary", "Primary", …
    ## $ school_laestab_as_used               <dbl> 2013614, 2022000, 2022001, 202200…
    ## $ number_preferences_la                <chr> "6", "6", "6", "6", "6", "6", "6"…
    ## $ school_name                          <chr> "The Aldgate School", "St Luke's …
    ## $ total_number_places_offered          <dbl> 30, 15, 30, 60, 43, 60, 37, 48, 3…
    ## $ number_preferred_offers              <dbl> 30, 15, 30, 60, 38, 60, 35, 48, 3…
    ## $ number_1st_preference_offers         <dbl> 30, 11, 23, 51, 34, 43, 28, 31, 2…
    ## $ number_2nd_preference_offers         <dbl> 0, 3, 3, 6, 3, 10, 4, 9, 0, 5, 3,…
    ## $ number_3rd_preference_offers         <dbl> 0, 1, 3, 3, 1, 2, 2, 2, 2, 1, 0, …
    ## $ times_put_as_any_preferred_school    <dbl> 81, 94, 129, 163, 72, 150, 98, 12…
    ## $ times_put_as_1st_preference          <dbl> 42, 21, 34, 56, 34, 44, 28, 31, 2…
    ## $ times_put_as_2nd_preference          <dbl> 16, 26, 34, 41, 14, 37, 20, 27, 1…
    ## $ times_put_as_3rd_preference          <dbl> 6, 24, 23, 25, 11, 23, 15, 13, 16…
    ## $ proportion_1stprefs_v_1stprefoffers  <chr> "1.4", "1.909090909", "1.47826087…
    ## $ proportion_1stprefs_v_totaloffers    <chr> "1.4", "1.4", "1.133333333", "0.9…
    ## $ all_applications_from_another_la     <dbl> 62, 19, 8, 54, 5, 34, 46, 35, 0, …
    ## $ offers_to_applicants_from_another_la <chr> "16", "3", "1", "20", "2", "11", …
    ## $ establishment_type                   <chr> "Voluntary aided school", "Free s…
    ## $ denomination                         <chr> "Faith", "Faith", "No religious c…
    ## $ fsm_eligible_percent                 <chr> "13.7", "22.4", "12.8", "34.2", "…
    ## $ admissions_policy                    <chr> "n/a", "n/a", "n/a", "n/a", "n/a"…
    ## $ urban_rural                          <chr> "Urban major conurbation", "Urban…
    ## $ allthrough_school                    <chr> "No", "No", "No", "No", "No", "No…
    ## $ school_urn                           <chr> "100000", "136807", "139837", "14…
    ## $ entry_year                           <chr> "R", "R", "R", "R", "R", "R", "R"…

From the code outputs above, we can see that this data frame has 171385
rows and 35 columns (a mix of character and numeric data types). The
columns include some identifiers for time, geography and school, some
descriptive dimensions for the number of preferences and type of school
and some measures relating to the number of applications and offers
made. Each row represents a single school for a single academic year.

## Info

This file contains additional information fields relating to primary and
secondary schools in all local authorities. It excludes nurseries,
special schools, children’s centers, pupil referral units and post-16
education. Once again, we can connect to it through Google Drive.

``` r
# Read in the source data for info
src_info_path <- "https://drive.google.com/file/d/1kUqKvphHnh4M-NfP4gXLAr9MxdxoWgMT/view?usp=sharing"
src_info <- read_csv_gdrive(src_info_path)
```

``` r
# List the columns and data types in the data frame
glimpse(src_info)
```

    ## Rows: 36,704
    ## Columns: 122
    ## $ urn                              <dbl> 100000, 100008, 100009, 100010, 10001…
    ## $ la_code                          <dbl> 201, 202, 202, 202, 202, 202, 202, 20…
    ## $ la_name                          <chr> "City of London", "Camden", "Camden",…
    ## $ establishment_number             <dbl> 3614, 2019, 2036, 2065, 2078, 2095, 2…
    ## $ establishment_name               <chr> "The Aldgate School", "Argyle Primary…
    ## $ type_of_establishment_name       <chr> "Voluntary aided school", "Community …
    ## $ establishment_type_group_name    <chr> "Local authority maintained schools",…
    ## $ establishment_status_name        <chr> "Open", "Open", "Open", "Open", "Open…
    ## $ reason_establishment_opened_name <chr> "Not applicable", "Not applicable", "…
    ## $ open_date                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ reason_establishment_closed_name <chr> "Not applicable", "Not applicable", "…
    ## $ close_date                       <chr> NA, NA, NA, NA, NA, "31-08-2021", NA,…
    ## $ phase_of_education_name          <chr> "Primary", "Primary", "Primary", "Pri…
    ## $ statutory_low_age                <dbl> 3, 3, 3, 2, 2, 3, 3, 3, 3, 7, 3, 2, 3…
    ## $ statutory_high_age               <dbl> 11, 11, 11, 11, 11, 11, 11, 11, 11, 1…
    ## $ boarders_name                    <chr> "No boarders", "No boarders", "No boa…
    ## $ nursery_provision_name           <chr> "Has Nursery Classes", "Has Nursery C…
    ## $ official_sixth_form_name         <chr> "Does not have a sixth form", "Does n…
    ## $ gender_name                      <chr> "Mixed", "Mixed", "Mixed", "Mixed", "…
    ## $ religious_character_name         <chr> "Church of England", "Does not apply"…
    ## $ religious_ethos_name             <chr> "Does not apply", "Does not apply", "…
    ## $ diocese_name                     <chr> "Diocese of London", "Not applicable"…
    ## $ admissions_policy_name           <chr> "Not applicable", "Not applicable", "…
    ## $ school_capacity                  <dbl> 276, 432, 446, 583, 459, 436, 232, 21…
    ## $ special_classes_name             <chr> "No Special Classes", "No Special Cla…
    ## $ census_date                      <chr> "21-01-2021", "21-01-2021", "21-01-20…
    ## $ number_of_pupils                 <dbl> 270, 335, 418, 367, 407, 211, 191, 23…
    ## $ number_of_boys                   <dbl> 133, 156, 231, 200, 212, 109, 88, 113…
    ## $ number_of_girls                  <dbl> 137, 179, 187, 167, 195, 102, 103, 11…
    ## $ percentage_fsm                   <dbl> 13.7, 51.9, 38.5, 49.1, 21.2, 57.8, 4…
    ## $ trust_school_flag_name           <chr> "Not applicable", "Not applicable", "…
    ## $ trusts_name                      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ school_sponsor_flag_name         <chr> "Not applicable", "Not applicable", "…
    ## $ school_sponsors_name             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ federation_flag_name             <chr> "Not under a federation", "Not under …
    ## $ federations_name                 <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ ukprn                            <dbl> 10079319, 10078065, 10077183, 1007385…
    ## $ fehe_identifier                  <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ further_education_type_name      <chr> "Not applicable", "Not applicable", "…
    ## $ ofsted_last_insp                 <chr> "19-04-2013", "30-01-2019", "23-03-20…
    ## $ last_changed_date                <chr> "26-04-2022", "18-05-2022", "16-06-20…
    ## $ street                           <chr> "St James's Passage", "Tonbridge Stre…
    ## $ locality                         <chr> "Duke's Place", NA, "West Hampstead",…
    ## $ address3                         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ town                             <chr> "London", "London", "London", "London…
    ## $ county_name                      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ postcode                         <chr> "EC3A 5DE", "WC1H 9EG", "NW6 1QL", "N…
    ## $ school_website                   <chr> "www.thealdgateschool.org", "http://w…
    ## $ telephone_num                    <dbl> 2072831147, 2078374590, 2074358646, 2…
    ## $ head_title_name                  <chr> "Miss", "Ms", "Mr", "Ms", "Mrs", "Ms"…
    ## $ head_first_name                  <chr> "Alexandra", "Jemima", "Samuel", "Hel…
    ## $ head_last_name                   <chr> "Allan", "Wade", "Drake", "Bruckdorfe…
    ## $ head_preferred_job_title         <chr> "Headteacher", "Headteacher", "Headte…
    ## $ bso_inspectorate_name_name       <chr> "Not applicable", "Not applicable", "…
    ## $ inspectorate_report              <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ date_of_last_inspection_visit    <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ next_inspection_visit            <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ teen_moth_name                   <chr> "Not applicable", "Not applicable", "…
    ## $ teen_moth_places                 <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ ccf_name                         <chr> "Not applicable", "Not applicable", "…
    ## $ senpru_name                      <chr> "Not applicable", "Not applicable", "…
    ## $ ebd_name                         <chr> "Not applicable", "Not applicable", "…
    ## $ places_pru                       <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ ft_prov_name                     <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ ed_by_other_name                 <chr> "Not applicable", "Not applicable", "…
    ## $ section41approved_name           <chr> "Not applicable", "Not applicable", "…
    ## $ sen1_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen2_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen3_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen4_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen5_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen6_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen7_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen8_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen9_name                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen10_name                       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen11_name                       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen12_name                       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen13_name                       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ type_of_resourced_provision_name <chr> NA, NA, NA, NA, NA, "Not applicable",…
    ## $ resourced_provision_on_roll      <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ resourced_provision_capacity     <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen_unit_on_roll                 <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen_unit_capacity                <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ gor_name                         <chr> "London", "London", "London", "London…
    ## $ district_administrative_name     <chr> "City of London", "Camden", "Camden",…
    ## $ administrative_ward_name         <chr> "Portsoken", "King's Cross", "Fortune…
    ## $ parliamentary_constituency_name  <chr> "Cities of London and Westminster", "…
    ## $ urban_rural_name                 <chr> "(England/Wales) Urban major conurbat…
    ## $ gssla_code_name                  <chr> "E09000001", "E09000007", "E09000007"…
    ## $ easting                          <dbl> 533498, 530238, 524888, 529912, 52870…
    ## $ northing                         <dbl> 181201, 182761, 185067, 184835, 18659…
    ## $ msoa_name                        <chr> "City of London 001", "Camden 025", "…
    ## $ lsoa_name                        <chr> "City of London 001F", "Camden 025C",…
    ## $ inspectorate_name_name           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen_stat                         <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sen_no_stat                      <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ props_name                       <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ ofsted_rating_name               <chr> "Outstanding", "Good", "Good", "Good"…
    ## $ rsc_region_name                  <chr> "North-West London and South-Central …
    ## $ country_name                     <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ uprn                             <dbl> 200000071925, 5090707, 5090655, 50906…
    ## $ site_name                        <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ qab_name_name                    <chr> "Not applicable", "Not applicable", "…
    ## $ establishment_accredited_name    <chr> "Not applicable", "Not applicable", "…
    ## $ qab_report                       <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ ch_number                        <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ msoa_code                        <chr> "E02000001", "E02000190", "E02000170"…
    ## $ lsoa_code                        <chr> "E01032739", "E01000941", "E01000873"…
    ## $ fsm                              <dbl> 37, 174, 161, 164, 84, 122, 92, 90, 6…
    ## $ link_1                           <chr> "Does not have links", "Does not have…
    ## $ link_2                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_3                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_4                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_5                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_6                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_7                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_8                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_9                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_10                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_11                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ link_12                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, N…

This data frame has 36704 rows and 122 columns. The columns are a mix of
character, numeric and logical[^1] data types. The columns include some
identifiers for time, geography and school, some descriptive dimensions
about each school and some measures relating to the number of pupils of
different types. Each row represents a single school and the data
represents the latest available.

## Performance

These files contain key stage 2 (KS2) performance data for primary
schools and key stage 4 (KS4) performance data for secondary schools in
England for academic years from 2014 onwards. Note that due to the
COVID-19 pandemic, the UK Government cancelled all statutory national
curriculum assessments due to be held in summer 2020 and 2021 at all Key
Stages. Therefore, no data is available for the 2019/20 or 2020/21
academic years. Further details including an explanation of the
terminology used in this dataset can be found
[here](https://drive.google.com/drive/folders/1vai66CUaYhPI0RXQI-BlC5kufZZyf3JU?usp=sharing).

The source data for performance is stored in several CSV files on the
Google Drive. Having read through the guidance notes for these files, it
seems that it is a difficult challenge to do a year-over-year comparison
of performance, due to the changes that are frequently made to the way
the tests are conducted and results reported. For the dashboard, I have
decided to use only the performance figures from the most recent year.
However, the data for previous years going back to 2014 is available in
the Google Drive.

``` r
# Read in the most recent performance data files
# 2018-19 KS2
src_perf_1819ks2_path <- "https://drive.google.com/file/d/1CmXvDtDOmIlXXUzZ9SPW4Yoti-rTzi75/view?usp=sharing"
src_perf_1819ks2 <- read_csv_gdrive(src_perf_1819ks2_path)

# 2018-19 KS4
src_perf_1819ks4_path <- "https://drive.google.com/file/d/1uBhU0yeuV97d66PRR60pq8UaRWvdGIaA/view?usp=sharing"
src_perf_1819ks4 <- read_csv_gdrive(src_perf_1819ks4_path)
```

These files contain a large number of columns. We will need to pick out
only the most relevant for reporting, which can be standardised across
all schools and all years.

# Clean data

## Offers

## Info

## Performance

[^1]: Columns which have been detected as logical, or boolean, always
    raise a small red flag for me. It can be an indicator that the
    column is empty of data (i.e. all values are `NA`). In this case, it
    looks like this is indeed what has happened, since running the
    `unique()` function over any of these columns always returns just a
    single value of `NA`. Therefore, I can safely exclude these columns
    from my analysis since they contain no useful data.
